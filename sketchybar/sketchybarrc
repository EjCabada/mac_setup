#!/bin/bash

# =============================================================================
# ‚öôÔ∏è CONFIGURATION
# =============================================================================

THEME="tokyonight"

# Fonts
FONT="JetBrainsMono Nerd Font"
ICON_FONT="sketchybar-app-font"
FONT_SIZE=14
ICON_SIZE=16

# Terminal (for click scripts)
TERMINAL="Ghostty"

# =============================================================================
# üé® THEME ENGINE
# =============================================================================

# COLOR KEY:
# BAR_BG_COLOR  -> Main bar background (usually transparent/semi-transparent)
# ITEM_BG       -> Background for the "pills" (Time, WiFi, etc.)
# ACCENT        -> Active highlights, popup borders, and the focused window border
# TEXT_COLOR    -> Main text and icons
# BORDER_COLOR  -> The thin border around the "pills"
# C_APPLE       -> Color of the Apple logo on the left
# C_* -> specific background colors for right-side widgets (Clock, Vol, etc.)

case "$THEME" in
  "tokyo_vivid") 
    BAR_BG_COLOR=0xff1a1b26
    ITEM_BG=0xff16161e
    ACCENT=0xff70cafa
    TEXT_COLOR=0xffffffff
    BORDER_COLOR=0xff24283b
    C_APPLE=0xff7dcfff
    C_CLOCK=0xff7aa2f7
    C_VOL=0xfff7768e
    C_BATT=0xff9ece6a
    C_WIFI=0xffe0af68
    C_RAM=0xffbb9af7
    C_DISK=0xff9ece6a
    ;;
  "rose_pine")
    BAR_BG_COLOR=0xff191724
    ITEM_BG=0xff26233a
    ACCENT=0xffebbcba
    TEXT_COLOR=0xffe0def4
    BORDER_COLOR=0xff1f1d2e
    C_APPLE=0xffc4a7e7
    C_CLOCK=0xff31748f
    C_VOL=0xffeb6f92
    C_BATT=0xff9ccfd8
    C_WIFI=0xfff6c177
    C_RAM=0xffebbcba
    C_DISK=0xff9ccfd8
    ;;
  "cyberpunk")
    BAR_BG_COLOR=0xff000000
    ITEM_BG=0xff1a1a1a
    ACCENT=0xfffcee0a
    TEXT_COLOR=0xffffffff
    BORDER_COLOR=0xff333333
    C_APPLE=0xffff003c
    C_CLOCK=0xff00ff9f
    C_VOL=0xfff60039
    C_BATT=0xff00ff9f
    C_WIFI=0xff00b8ff
    C_RAM=0xffbc00dd
    C_DISK=0xff00ff9f
    ;;
  "gruvbox")
    BAR_BG_COLOR=0xff1d2021
    ITEM_BG=0xff3c3836
    ACCENT=0xffe6b035
    TEXT_COLOR=0xfff2e7c9
    BORDER_COLOR=0xff111111
    C_APPLE=0xffcc241d
    C_CLOCK=0xff458588
    C_VOL=0xffb16286
    C_BATT=0xff769e5a
    C_WIFI=0xffd79921
    C_RAM=0xff558057
    C_DISK=0xff769e5a
    ;;
  "tokyonight")
    BAR_BG_COLOR=0xff1a1b26
    ITEM_BG=0xff24283b
    ACCENT=0xff6e54ff
    TEXT_COLOR=0xffffffff
    BORDER_COLOR=0xff111111
    C_APPLE=0xfff7768e
    C_CLOCK=0xff7aa2f7
    C_VOL=0xffbb9af7
    C_BATT=0xff9ece6a
    C_WIFI=0xffe0af68
    C_RAM=0xff7dcfff
    C_DISK=0xff9ece6a
    ;;
  "catppuccin")
    BAR_BG_COLOR=0xff1e1e2e
    ITEM_BG=0xff313244
    ACCENT=0xff5291f7
    TEXT_COLOR=0xffffffff
    BORDER_COLOR=0xff111111
    C_APPLE=0xfff38ba8
    C_CLOCK=0xff89b4fa
    C_VOL=0xfff5c2e7
    C_BATT=0xffa6e3a1
    C_WIFI=0xfffab387
    C_RAM=0xff94e2d5
    C_DISK=0xffa6e3a1
    ;;
  "matrix")
    BAR_BG_COLOR=0xff000000
    ITEM_BG=0xff003300
    ACCENT=0xff00ff00
    TEXT_COLOR=0xff00ff00
    BORDER_COLOR=0xff111111
    C_APPLE=0xff007700
    C_CLOCK=0xff003300
    C_VOL=0xff004400
    C_BATT=0xff005500
    C_WIFI=0xff006600
    C_RAM=0xff008800
    C_DISK=0xff005500
    ;;
  "apple_calendar")
    BAR_BG_COLOR=0xffffffff
    ITEM_BG=0xff1c1c1e
    ACCENT=0xffef4743
    TEXT_COLOR=0xffffffff
    BORDER_COLOR=0xff000000
    C_APPLE=0xff999999
    C_CLOCK=0xffef4743
    C_VOL=0xff999999
    C_BATT=0xff00ff00
    C_WIFI=0xffef4743
    C_RAM=0xffef4743
    C_DISK=0xff999999
    ;;
  "cool_grays")
    BAR_BG_COLOR=0xff263238
    ITEM_BG=0xff424242
    ACCENT=0xff90a4ae
    TEXT_COLOR=0xffe0e0e0
    BORDER_COLOR=0xff111111
    C_APPLE=0xffff8a65
    C_CLOCK=0xff90a4ae
    C_VOL=0xfff0f4f8
    C_BATT=0xff81c784
    C_WIFI=0xff90a4ae
    C_RAM=0xffb3e5fc
    C_DISK=0xff81c784
    ;;
  "github_dark")
    BAR_BG_COLOR=0xff0d1117
    ITEM_BG=0xff161b22
    ACCENT=0xff3392ff
    TEXT_COLOR=0xffffffff
    BORDER_COLOR=0xff111111
    C_APPLE=0xfff85149
    C_CLOCK=0xff58a6ff
    C_VOL=0xffbc8cff
    C_BATT=0xff3fb950
    C_WIFI=0xfff0b347
    C_RAM=0xff479cf0
    C_DISK=0xff3fb950
    ;;
  "nature_neutrals")
    BAR_BG_COLOR=0xff3a485f
    ITEM_BG=0xff505e7a
    ACCENT=0xffdf9a66
    TEXT_COLOR=0xffe6e1d2
    BORDER_COLOR=0xff111111
    C_APPLE=0xffcf5f57
    C_CLOCK=0xffdf9a66
    C_VOL=0xff8c95ab
    C_BATT=0xffb3c28a
    C_WIFI=0xffdf9a66
    C_RAM=0xffb3b6e3
    C_DISK=0xffb3c28a
    ;;
  "unity_simplex")
    BAR_BG_COLOR=0xff1f1b24
    ITEM_BG=0xff312c36
    ACCENT=0xff6200ea
    TEXT_COLOR=0xfff0eef3
    BORDER_COLOR=0xff111111
    C_APPLE=0xffd1c4e9
    C_CLOCK=0xff6200ea
    C_VOL=0xffb388ff
    C_BATT=0xff7e57c2
    C_WIFI=0xff6200ea
    C_RAM=0xff4527a0
    C_DISK=0xff7e57c2
    ;;
  "neobrutal")
    BAR_BG_COLOR=0xff222222
    ITEM_BG=0xff111111
    ACCENT=0xffff6d1f
    TEXT_COLOR=0xffe3e7e0
    BORDER_COLOR=0xff000000
    C_APPLE=0xffd62a43
    C_CLOCK=0xff06d6a0
    C_VOL=0xffb2124d
    C_BATT=0xff06d6a0
    C_WIFI=0xffff6d1f
    C_RAM=0xff1581bf
    C_DISK=0xff06d6a0
    ;;
  "monokai")
    BAR_BG_COLOR=0xff272822
    ITEM_BG=0xff383830
    ACCENT=0xffe6db74
    TEXT_COLOR=0xfff8f8f2
    BORDER_COLOR=0xff111111
    C_APPLE=0xfff92672
    C_CLOCK=0xffa6e22e
    C_VOL=0xfff92672
    C_BATT=0xffa6e22e
    C_WIFI=0xfffd971f
    C_RAM=0xff66d9ef
    C_DISK=0xffa6e22e
    ;;
  "plain_dark")
    BAR_BG_COLOR=0xff1a1a1a
    ITEM_BG=0xff0a0a0a
    ACCENT=0xffffffff
    TEXT_COLOR=0xffffffff
    BORDER_COLOR=0xff111111
    C_APPLE=0xff2a2a2a
    C_CLOCK=0xff2a2a2a
    C_VOL=0xff2a2a2a
    C_BATT=0xff2a2a2a
    C_WIFI=0xff2a2a2a
    C_RAM=0xff2a2a2a
    C_DISK=0xff2a2a2a
    ;;
  "nord")
    BAR_BG_COLOR=0xff2e3440
    ITEM_BG=0xff3b4252
    ACCENT=0xff64cfed
    TEXT_COLOR=0xffeceff4
    BORDER_COLOR=0xff111111
    C_APPLE=0xff4c566a
    C_CLOCK=0xff4c566a
    C_VOL=0xff4c566a
    C_BATT=0xff4c566a
    C_WIFI=0xff4c566a
    C_RAM=0xff4c566a
    C_DISK=0xff4c566a
    ;;
  "dark_forest")
    BAR_BG_COLOR=0xff1c2826
    ITEM_BG=0xff2a3930
    ACCENT=0xff65c257
    TEXT_COLOR=0xffe0e0e0
    BORDER_COLOR=0xff111111
    C_APPLE=0xffbf616a
    C_CLOCK=0xff89b482
    C_VOL=0xffc7a884
    C_BATT=0xffa3be8c
    C_WIFI=0xff89b482
    C_RAM=0xff81a1c1
    C_DISK=0xffa3be8c
    ;;
  "neon_drive")
    BAR_BG_COLOR=0xff000000
    ITEM_BG=0xff0d0d0d
    ACCENT=0xff44ff21
    TEXT_COLOR=0xffffffff
    BORDER_COLOR=0xff111111
    C_APPLE=0xffff0000
    C_CLOCK=0xff02cfcf
    C_VOL=0xffff1493
    C_BATT=0xff31e012
    C_WIFI=0xff02cfcf
    C_RAM=0xff9400d3
    C_DISK=0xff31e012
    ;;
  "midnight_blue")
    BAR_BG_COLOR=0xff1d2334
    ITEM_BG=0xff2a344d
    ACCENT=0xff8a9dc0
    TEXT_COLOR=0xffe6e6e6
    BORDER_COLOR=0xff111111
    C_APPLE=0xffc08a8a
    C_CLOCK=0xff8a9dc0
    C_VOL=0xffc08a9d
    C_BATT=0xffa3c08a
    C_WIFI=0xff8a9dc0
    C_RAM=0xff8a9dc0
    C_DISK=0xffa3c08a
    ;;
  "charcoal_muted")
    BAR_BG_COLOR=0xff282c34
    ITEM_BG=0xff3e4451
    ACCENT=0xff61afef
    TEXT_COLOR=0xffabb2bf
    BORDER_COLOR=0xff111111
    C_APPLE=0xffe06c75
    C_CLOCK=0xff61afef
    C_VOL=0xffc678dd
    C_BATT=0xff98c379
    C_WIFI=0xffe5c07b
    C_RAM=0xff56b6c2
    C_DISK=0xff98c379
    ;;
  "coffee_latte")
    BAR_BG_COLOR=0xff2f2924
    ITEM_BG=0xff403933
    ACCENT=0xffd4aa70
    TEXT_COLOR=0xffe7e5e1
    BORDER_COLOR=0xff111111
    C_APPLE=0xffc98179
    C_CLOCK=0xffd4aa70
    C_VOL=0xffa69078
    C_BATT=0xffa2b29f
    C_WIFI=0xffd4aa70
    C_RAM=0xff95b7b9
    C_DISK=0xffa2b29f
    ;;
esac

# =============================================================================
# üì§ EXPORTS & EXTERNAL CONFIGS
# =============================================================================

export COLOR_ACCENT=$ACCENT
export COLOR_ITEM_BG=$ITEM_BG
export COLOR_TEXT=$TEXT_COLOR
export COLOR_BAR=$BAR_BG_COLOR
export COLOR_BORDER=$BORDER_COLOR

# Write shared colors file
echo "#!/bin/bash" > "$HOME/.config/sketchybar/colors.sh"
echo "export COLOR_ACCENT=$ACCENT" >> "$HOME/.config/sketchybar/colors.sh"
echo "export COLOR_ITEM_BG=$ITEM_BG" >> "$HOME/.config/sketchybar/colors.sh"
echo "export COLOR_TEXT=$TEXT_COLOR" >> "$HOME/.config/sketchybar/colors.sh"
echo "export COLOR_BAR=$BAR_BG_COLOR" >> "$HOME/.config/sketchybar/colors.sh"
echo "export COLOR_BORDER=$BORDER_COLOR" >> "$HOME/.config/sketchybar/colors.sh"

# JANKYBORDERS SYNC
# inactive_color=0x00000000 ensures transparent (no) borders when not focused
borders active_color=$ACCENT inactive_color=0x00000000 width=6.0 &

# =============================================================================
# üöÄ INITIALIZATION
# =============================================================================

sketchybar --bar \
  height=36 \
  color=0x00000000 \
  position=top \
  sticky=on \
  padding_left=10 \
  padding_right=10 \
  notch_width=188 \
  display=all

sketchybar --default \
  icon.font="$FONT:Bold:$ICON_SIZE" \
  label.font="$FONT:SemiBold:$FONT_SIZE" \
  icon.color=$TEXT_COLOR \
  label.color=$TEXT_COLOR \
  background.height=28 \
  background.padding_left=2 \
  background.padding_right=2 \
  background.corner_radius=10 \
  background.border_width=2 \
  background.border_color=$BORDER_COLOR \
  background.color=$ITEM_BG \
  icon.padding_left=10 \
  icon.padding_right=5 \
  label.padding_left=5 \
  label.padding_right=10 \
  label.y_offset=0 \
  popup.background.border_width=2 \
  popup.background.corner_radius=10 \
  popup.background.border_color=$ACCENT \
  popup.background.color=$BAR_BG_COLOR \
  popup.blur_radius=20

# =============================================================================
# üçé LEFT SIDE
# =============================================================================

# 1. Apple Logo
sketchybar --add item apple left \
           --set apple icon="ÔÖπ" \
                       icon.color=$C_APPLE \
                       icon.font.size=20 \
                       label.drawing=off \
                       background.color=$ITEM_BG \
                       background.drawing=on \
                       click_script="open /System/Library/PreferencePanes/Appearance.prefPane"

# 2. Spaces (Loops through Aerospace workspaces)
sketchybar --add event aerospace_workspace_change
for sid in $(aerospace list-workspaces --all); do
    sketchybar --add item space.$sid left \
        --subscribe space.$sid aerospace_workspace_change front_app_switched \
        --set space.$sid \
        icon="$sid" \
        background.color=0x44ffffff \
        background.drawing=off \
        label.drawing=on \
        label.font="$ICON_FONT:Regular:14.0,SF Pro Display:Regular:13.0" \
        script="$HOME/.config/sketchybar/plugins/space_windows.sh $sid" \
        click_script="aerospace workspace $sid"
done

# 3. Front App Indicator
sketchybar --add item front_app left \
           --set front_app icon.drawing=off \
                           label.font="$FONT:Bold:13.0" \
                           background.color=$ACCENT \
                           background.drawing=on \
                           label.color=0xff1d2021 \
                           script="$HOME/.config/sketchybar/plugins/front_app.sh" \
           --subscribe front_app front_app_switched

# =============================================================================
# üîå RIGHT SIDE
# =============================================================================

# Theme Switcher Menu
sketchybar --add item theme_menu right \
           --set theme_menu icon="Ôìì" \
                 icon.font="$FONT:Bold:20.0" \
                 label.drawing=off \
                 background.color=$C_WIFI \
                 icon.padding_right=15 \
                 icon.padding_left=15 \
                 popup.anchor=right \
                 popup.align=right \
                 click_script="sketchybar --set \$NAME popup.drawing=toggle"

# Settings Gear Menu
sketchybar --add item prefs right \
           --set prefs icon="‚öôÔ∏é" \
                 icon.font="$FONT:Bold:22.0" \
                 label.drawing=off \
                 background.color=$C_CLOCK \
                 icon.padding_right=15 \
                 icon.padding_left=15 \
                 popup.anchor=right \
                 popup.align=right \
                 click_script="sketchybar --set \$NAME popup.drawing=toggle"

# Standard Widgets
sketchybar --add item clock right \
           --set clock script="$HOME/.config/sketchybar/plugins/clock.sh" \
                 icon="ÔÄó" update_freq=30 background.color=$C_CLOCK \
                 click_script="open -a Calendar"

sketchybar --add item volume right \
           --set volume script="$HOME/.config/sketchybar/plugins/volume.sh" \
                 icon="ÔÄ®" background.color=$C_VOL \
                 click_script="osascript -e 'set volume output muted not (output muted of (get volume settings))'; sketchybar --trigger volume_change" \
           --subscribe volume volume_change

sketchybar --add item battery right \
           --set battery script="$HOME/.config/sketchybar/plugins/battery.sh" \
                 icon="ÔâÄ" update_freq=120 background.color=$C_BATT \
                 label.drawing=on \
                 click_script="open -a 'Activity Monitor'" \
                 --subscribe battery power_source_change system_woke

sketchybar --add item wifi right \
           --set wifi script="$HOME/.config/sketchybar/plugins/wifi.sh" \
                 icon="Ôá´" background.color=$C_WIFI \
                 click_script="open /System/Library/PreferencePanes/Network.prefPane"

sketchybar --add item disk right \
           --set disk script="$HOME/.config/sketchybar/plugins/disk.sh" \
                 icon="ÔÉá" background.color=$C_DISK update_freq=60

sketchybar --add item ram right \
           --set ram script="$HOME/.config/sketchybar/plugins/ram.sh" \
                 icon="ÓøÖ" background.color=$C_RAM

# =============================================================================
# üõ† MENUS
# =============================================================================

# Prefs Menu (Shortcuts & Configs)
sketchybar --add item prefs.title2 popup.prefs \
           --set prefs.title2 icon="Ô¢£" label="SHORTCUTS" label.font="$FONT:Bold:14.0" \
           \
           --add item open.htop popup.prefs \
           --set open.htop icon="Ôíâ" label="Open htop" \
                 click_script="open -a $TERMINAL --args htop; sketchybar --set prefs popup.drawing=off" \
           \
           --add item open.ollama popup.prefs \
           --set open.ollama icon="ÓØà" label="Run Ollama" \
                 click_script="open -a $TERMINAL --args ollama run llama2; sketchybar --set prefs popup.drawing=off" \
           \
           --add item prefs.title3 popup.prefs \
           --set prefs.title3 icon="ÔÅº" label="CONFIGS" label.font="$FONT:Bold:14.0" \
           \
           --add item conf.sketchy popup.prefs \
           --set conf.sketchy icon="üîß" label="SketchyBar Config" \
                 click_script="open -a $TERMINAL '$HOME/.config/sketchybar'; sketchybar --set prefs popup.drawing=off" \
           \
           --add item conf.aero popup.prefs \
           --set conf.aero icon="Ó´é" label="Aerospace Config" \
                 click_script="open -a $TERMINAL '$HOME/.config/aerospace'; sketchybar --set prefs popup.drawing=off" \
           \
           --add item conf.notes popup.prefs \
           --set conf.notes icon="Ôí≠" label="Setup Notes" \
                 click_script="open -a $TERMINAL '$HOME/icloud/Config Setup Explination'; sketchybar --set prefs popup.drawing=off"

# Theme Menu (Consolidated Loop)
sketchybar --add item theme.title popup.theme_menu \
           --set theme.title icon="Ôìì" label="SELECT THEME" label.font="$FONT:Bold:14.0"

# List of themes in format: "id:icon:Label"
THEME_OPTIONS=(
  "nord:Óòé:Nord"
  "plain_dark:Ô¢£:Plain Dark"
  "dark_forest:ÔÜ∞:Dark Forest"
  "neon_drive:Ô†å:Neon Drive"
  "midnight_blue:Óé•:Midnight Blue"
  "charcoal_muted:Ô†ï:Charcoal Muted"
  "coffee_latte:ÔÉ¥:Coffee Latte"
  "gruvbox:Óπ≤:Gruvbox"
  "tokyonight:Ôí°:Tokyo Night"
  "catppuccin:ÔÜÜ:Catppuccin"
  "matrix:ÔîÅ:Matrix"
  "github_dark:ÔÑì:GitHub Dark"
  "monokai:ÔÉ´:Monokai"
  "apple_calendar:Óúè:Apple Calendar"
  "cool_grays:Ô†π:Cool Grays"
  "nature_neutrals:ÔÜ±:Nature's Neutrals"
  "unity_simplex:ÔÜÆ:Unity Simplex"
  "neobrutal:Ôõï:Neo-Brutalist"
  "tokyo_vivid:Ôõï:Tokyo Vivid"
  "rose_pine:Ôõï:Rose Pine"
  "cyberpunk:Ôõï:Cyberpunk"
)

for theme in "${THEME_OPTIONS[@]}"; do
  # Split string by ':' delimiter
  IFS=':' read -r id icon label <<< "$theme"
  
  sketchybar --add item theme.$id popup.theme_menu \
             --set theme.$id icon="$icon" label="$label" \
                   click_script="$HOME/.config/sketchybar/plugins/switch_theme.sh $id"
done

sketchybar --update
echo "Config loaded."
